/*  (6) - All Unit and Property Details - placed into tblProperties and tblPropertyUnits
*/

SELECT 
    u.hMy as yardiUnitRowID, 
    p.hMy as yardiPropertyRowID,
    LTRIM(p.scode) as BuildingCode, 
    ISNULL(p.saddr1,'') as addr1_Co, 
    ISNULL(p.saddr2,'') as addr2, 
    ISNULL(p.saddr3,'') as addr3, 
    ISNULL(p.saddr4,'') as addr4, 
    ISNULL(p.sCity,'') as City, 
    ISNULL(p.sState,'') as StateCode, 
    ISNULL(LTRIM(sZipCode),'') as zipCode,
    ISNULL(u.scode,'') as AptNumber,
    u.srent as Rent,
    u.sStatus as UnitStatus,
    ISNULL(u.ibedrooms,0) as Bedrooms,
    us.LastMoveInDate,
    us.LastMoveOutDate,
    u.DSQFT as SqFt,
    ISNULL(p.bInactive,0) as isPropertyInactive,  --  -1 = True/Inactive
    p.dtInactive as propertyInactiveDate,
    ISNULL(u.exclude,0) as isUnitExcluded,        -- -1 = True/Excluded
    t.LastTenantRent,
    ut.sDesc as UnitTypeDesc,
	CASE WHEN postProps.HPROPERTY IS NOT NULL THEN 1 ELSE 0 END AS isInList_Posting

FROM unit u
	INNER JOIN property p ON u.hproperty = p.hMy

	-- Last move in/out per unit
	LEFT JOIN (
		SELECT hUnit, 
			   MAX(dtMoveIn)  AS LastMoveInDate, 
			   MAX(dtMoveOut) AS LastMoveOutDate 
		FROM unit_status 
		WHERE hUnit > 0 
		GROUP BY hUnit
	) AS us 
		ON u.hMy = us.hUnit

	-- Last tenant rent per unit
	LEFT JOIN (
		SELECT hUnit, sRent AS LastTenantRent
		FROM (
			SELECT hUnit, sRent,
				   ROW_NUMBER() OVER (PARTITION BY hUnit ORDER BY dtLeaseFrom DESC) AS rn
			FROM tenant
		) AS x
		WHERE x.rn = 1
	) AS t 
		ON u.hMy = t.hUnit

	LEFT JOIN unittype ut 
		ON u.hUnitType = ut.hMy

	-- Prefiltered set of properties that are in the 'Posting' list
	LEFT JOIN (
		SELECT DISTINCT lp.HPROPERTY
		FROM LISTPROP lp
		JOIN PROPERTY pl 
			ON pl.HMY = lp.HPROPLIST
		WHERE pl.SCODE = 'Posting'
	) AS postProps
		ON postProps.HPROPERTY = p.HMY

WHERE 
    u.hMy IS NOT NULL
    AND p.hMy IS NOT NULL
    AND u.scode IS NOT NULL 
    AND p.scode IS NOT NULL
    --AND p.scode='3655'
    --AND u.scode='3658-2B'

ORDER BY
    p.scode, u.scode
