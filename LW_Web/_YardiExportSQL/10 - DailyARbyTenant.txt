/* (10) Month-End A/R by Tenant — SLICED, READ-ONLY
   Mapping (proven with Y9/Y10):
     CHARGES  = iType 7  (amount = Trans.sTotalAmount; HAP via Trans.sNotes)
     RECEIPTS = iType 6  (amount = Trans.sTotalAmount; HAP via Trans.sUserDefined2)
   BFWD = CHARGES_before_month − RECEIPTS_before_month
   Carry-in = net (charges − receipts) before the slice’s FIRST month start
   Output columns (match dbo.tblStg_TenantARSummary):
     AsOfDate, yardiPersonRowID, yardiPropertyRowID, yardiUnitRowID, balanceFwd, charges, receipts, endingBalance
*/

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;

DECLARE @MonthsBack int = 6;      -- total window behind @AsOfDate
DECLARE @SliceSize  int = 3;       -- months per export
DECLARE @SliceIndex int = 1;       -- run 1..6
DECLARE @AsOfDate   date = EOMONTH(DATEADD(MONTH,-1,CAST(GETDATE() AS date)));

-- Overall 24-month window start (first day)
DECLARE @WindowStart date = DATEADD(DAY,1,EOMONTH(DATEADD(MONTH,-@MonthsBack,@AsOfDate)));

-- Compute the slice FIRST month start and LAST month end
DECLARE @SliceStartOffset int = (@SliceIndex - 1) * @SliceSize;
DECLARE @SliceEndOffset   int = @SliceStartOffset + @SliceSize - 1;

DECLARE @FirstMonthStart date = DATEFROMPARTS(YEAR(DATEADD(MONTH,@SliceStartOffset,@WindowStart)),
                                              MONTH(DATEADD(MONTH,@SliceStartOffset,@WindowStart)),1);
DECLARE @LastMonthEnd    date = EOMONTH(DATEADD(MONTH,@SliceEndOffset,@WindowStart));
IF @LastMonthEnd > @AsOfDate SET @LastMonthEnd = @AsOfDate;

;WITH N AS (
  SELECT ROW_NUMBER() OVER (ORDER BY (SELECT NULL)) - 1 AS n
  FROM sys.all_objects
),
MonthEnds AS (
  SELECT DISTINCT EOMONTH(DATEADD(MONTH,n,@FirstMonthStart)) AS AsOfDate
  FROM N
  WHERE DATEADD(MONTH,n,@FirstMonthStart) <= @LastMonthEnd
),
Tx AS (
  SELECT
      tr.hPerson,
      tr.hProp,
      tr.hMy,
      tr.iType,
      CAST(tr.uPostDate AS date) AS PostDate,
      tr.sTotalAmount,
      tr.sUserDefined2,      -- for HAP test on receipts
      tr.sNotes AS trNotes   -- for HAP test on charges
  FROM Trans tr
  WHERE tr.iType IN (6,7)
    AND CAST(tr.uPostDate AS date) BETWEEN @FirstMonthStart AND DATEADD(DAY,1,@LastMonthEnd)
    AND tr.hMy BETWEEN 600000000 AND 799999999
),
Tenants AS (
  SELECT t.hMyPerson, t.hUnit, t.hProperty
  FROM Tenant t
  JOIN TenStatus ts ON ts.iStatus = t.iStatus
  WHERE ts.Status LIKE 'Current%'         -- same filter your report uses
),
CarryIn AS (  -- net up to the day BEFORE the slice's first month
  SELECT
    tr.hPerson,
    SUM(CASE WHEN tr.iType=7 AND SUBSTRING(ISNULL(tr.sNotes,'N/A'),1,4) <> ':HAP'
             THEN ISNULL(tr.sTotalAmount,0) ELSE 0 END)
  - SUM(CASE WHEN tr.iType=6 AND SUBSTRING(ISNULL(tr.sUserDefined2,'N/A'),1,4) <> ':HAP'
             THEN ISNULL(tr.sTotalAmount,0) ELSE 0 END) AS NetBefore
  FROM Trans tr
  WHERE CAST(tr.uPostDate AS date) < @FirstMonthStart
    AND tr.iType IN (6,7)
  GROUP BY tr.hPerson
),
Base AS (
  -- Real transactions inside the slice
  SELECT
      me.AsOfDate,
      tn.hProperty      AS yardiPropertyRowID,
      tn.hUnit          AS yardiUnitRowID,
      tx.hPerson        AS yardiPersonRowID,
      tx.PostDate,
      tx.iType,
      CASE WHEN tx.iType=7 AND SUBSTRING(ISNULL(tx.trNotes,'N/A'),1,4) <> ':HAP'
           THEN ISNULL(tx.sTotalAmount,0) ELSE 0 END AS ChargeAmt,
      CASE WHEN tx.iType=6 AND SUBSTRING(ISNULL(tx.sUserDefined2,'N/A'),1,4) <> ':HAP'
           THEN ISNULL(tx.sTotalAmount,0) ELSE 0 END AS ReceiptAmt
  FROM MonthEnds me
  JOIN Tx       tx ON tx.PostDate <= me.AsOfDate
  JOIN Tenants  tn ON tn.hMyPerson = tx.hPerson

  UNION ALL

  -- Synthetic carry-in row (dated day BEFORE the first month start) so it feeds the month-1 BFWD
  SELECT
      me.AsOfDate,
      tn.hProperty,
      tn.hUnit,
      ci.hPerson                    AS yardiPersonRowID,
      DATEADD(DAY,-1,@FirstMonthStart) AS PostDate,
      0 AS iType,
      CASE WHEN ci.NetBefore > 0 THEN ci.NetBefore ELSE 0 END AS ChargeAmt,
      CASE WHEN ci.NetBefore < 0 THEN -ci.NetBefore ELSE 0 END AS ReceiptAmt
  FROM MonthEnds me
  JOIN CarryIn ci   ON 1=1
  JOIN Tenants  tn  ON tn.hMyPerson = ci.hPerson
),
Rollup AS (
  SELECT
      b.AsOfDate,
      b.yardiPropertyRowID,
      b.yardiUnitRowID,
      b.yardiPersonRowID,
      -- Correct sign for BFWD
      SUM(CASE WHEN b.PostDate < DATEFROMPARTS(YEAR(b.AsOfDate),MONTH(b.AsOfDate),1)
               THEN (b.ChargeAmt - b.ReceiptAmt) ELSE 0 END) AS balanceFwd,
      SUM(CASE WHEN b.iType=7 AND b.PostDate BETWEEN DATEFROMPARTS(YEAR(b.AsOfDate),MONTH(b.AsOfDate),1) AND b.AsOfDate
               THEN b.ChargeAmt ELSE 0 END) AS charges,
      SUM(CASE WHEN b.iType=6 AND b.PostDate BETWEEN DATEFROMPARTS(YEAR(b.AsOfDate),MONTH(b.AsOfDate),1) AND b.AsOfDate
               THEN b.ReceiptAmt ELSE 0 END) AS receipts
  FROM Base b
  GROUP BY b.AsOfDate, b.yardiPropertyRowID, b.yardiUnitRowID, b.yardiPersonRowID
)
SELECT
    r.AsOfDate,
    r.yardiPersonRowID,
    r.yardiPropertyRowID,
    r.yardiUnitRowID,
    CAST(r.balanceFwd AS decimal(12,2)) AS balanceFwd,
    CAST(r.charges    AS decimal(12,2)) AS charges,
    CAST(r.receipts   AS decimal(12,2)) AS receipts,
    CAST(r.balanceFwd + r.charges - r.receipts AS decimal(12,2)) AS endingBalance
FROM Rollup r
ORDER BY r.AsOfDate, r.yardiPropertyRowID, r.yardiUnitRowID, r.yardiPersonRowID;
