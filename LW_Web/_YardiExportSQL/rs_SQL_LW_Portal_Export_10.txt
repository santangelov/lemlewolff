//Notes
//End Notes

//Title
LW Portal Export-File10
//End Title

//Select
DECLARE @MonthsBack int = 3;
DECLARE @SliceSize  int = 3;
DECLARE @SliceIndex int = 1;

DECLARE @HAPMode varchar(10) = 'Include'   

DECLARE @AsOfDate date = EOMONTH(DATEADD(MONTH,-1,CAST(GETDATE() AS date)));

DECLARE @WindowStart date =
    DATEADD(DAY,1,EOMONTH(DATEADD(MONTH,-@MonthsBack,@AsOfDate)));

DECLARE @SliceStartOffset int = (@SliceIndex - 1) * @SliceSize;
DECLARE @SliceEndOffset   int = @SliceStartOffset + @SliceSize - 1;

DECLARE @FirstMonthStart date =
    DATEFROMPARTS(
        YEAR(DATEADD(MONTH,@SliceStartOffset,@WindowStart)),
        MONTH(DATEADD(MONTH,@SliceStartOffset,@WindowStart)),
        1
    );

DECLARE @LastMonthEnd date =
    EOMONTH(DATEADD(MONTH,@SliceEndOffset,@WindowStart));

IF @LastMonthEnd > @AsOfDate SET @LastMonthEnd = @AsOfDate;

SELECT
    r.AsOfDate,
    r.yardiPersonRowID,
    r.yardiPropertyRowID,
    r.yardiUnitRowID,
    CAST(r.balanceFwd AS decimal(12,2)) AS balanceFwd,
    CAST(r.charges    AS decimal(12,2)) AS charges,
    CAST(r.receipts   AS decimal(12,2)) AS receipts,
    CAST(r.balanceFwd + r.charges - r.receipts AS decimal(12,2)) AS endingBalance
FROM (

    SELECT
        b.AsOfDate,
        b.yardiPropertyRowID,
        b.yardiUnitRowID,
        b.yardiPersonRowID,

        SUM(
            CASE WHEN b.PostDate < DATEFROMPARTS(YEAR(b.AsOfDate),MONTH(b.AsOfDate),1)
                 THEN (b.ChargeAmt - b.ReceiptAmt)
                 ELSE 0 END
        ) AS balanceFwd,

        SUM(
            CASE WHEN b.iType = 7
                  AND b.PostDate BETWEEN DATEFROMPARTS(YEAR(b.AsOfDate),MONTH(b.AsOfDate),1)
                                     AND b.AsOfDate
                 THEN b.ChargeAmt ELSE 0 END
        ) AS charges,

        SUM(
            CASE WHEN b.iType = 6
                  AND b.PostDate BETWEEN DATEFROMPARTS(YEAR(b.AsOfDate),MONTH(b.AsOfDate),1)
                                     AND b.AsOfDate
                 THEN b.ReceiptAmt ELSE 0 END
        ) AS receipts

    FROM (

        SELECT
            me.AsOfDate,
            tn.hProperty AS yardiPropertyRowID,
            tn.hUnit     AS yardiUnitRowID,
            tx.hPerson   AS yardiPersonRowID,
            tx.PostDate,
            tx.iType,
            CASE 
                WHEN tx.iType=7 AND (
                    (@HAPMode='Exclude' AND SUBSTRING(ISNULL(tx.trNotes,''),1,4)=':HAP')
                    OR (@HAPMode='Only' AND SUBSTRING(ISNULL(tx.trNotes,''),1,4) <> ':HAP')
                )
                THEN 0
                WHEN tx.iType=7 AND SUBSTRING(ISNULL(tx.trNotes,'N/A'),1,4) <> ':HAP'
                THEN ISNULL(tx.sTotalAmount,0)
                ELSE 0
            END AS ChargeAmt,

            CASE 
                WHEN tx.iType=6 AND (
                    (@HAPMode='Exclude' AND SUBSTRING(ISNULL(tx.sUserDefined2,''),1,4)=':HAP')
                    OR (@HAPMode='Only' AND SUBSTRING(ISNULL(tx.sUserDefined2,''),1,4) <> ':HAP')
                )
                THEN 0
                WHEN tx.iType=6 AND SUBSTRING(ISNULL(tx.sUserDefined2,'N/A'),1,4) <> ':HAP'
                THEN ISNULL(tx.sTotalAmount,0)
                ELSE 0
            END AS ReceiptAmt

        FROM (
            SELECT DISTINCT EOMONTH(DATEADD(MONTH,n,@FirstMonthStart)) AS AsOfDate
            FROM (
                SELECT ROW_NUMBER() OVER (ORDER BY (SELECT NULL)) - 1 AS n
                FROM sys.all_objects
            ) AS nums
            WHERE DATEADD(MONTH,n,@FirstMonthStart) <= @LastMonthEnd
        ) AS me

        JOIN (
            SELECT
                tr.hPerson,
                tr.hProp,
                tr.hMy,
                tr.iType,
                CAST(tr.uPostDate AS date) AS PostDate,
                tr.sTotalAmount,
                tr.sUserDefined2,
                tr.sNotes AS trNotes
            FROM Trans tr
            WHERE tr.iType IN (6,7)
              AND CAST(tr.uPostDate AS date)
                    BETWEEN @FirstMonthStart AND DATEADD(DAY,1,@LastMonthEnd)
              AND tr.hMy BETWEEN 600000000 AND 799999999
        ) AS tx ON tx.PostDate <= me.AsOfDate

        JOIN (
            SELECT t.hMyPerson, t.hUnit, t.hProperty
            FROM Tenant t
            JOIN TenStatus ts ON ts.iStatus = t.iStatus
            WHERE ts.Status LIKE 'Current%'
        ) AS tn ON tn.hMyPerson = tx.hPerson


        UNION ALL


        SELECT
            me.AsOfDate,
            tn.hProperty,
            tn.hUnit,
            ci.hPerson,
            DATEADD(DAY,-1,@FirstMonthStart),
            0,

            CASE WHEN ci.NetBefore > 0 THEN ci.NetBefore ELSE 0 END,
            CASE WHEN ci.NetBefore < 0 THEN -ci.NetBefore ELSE 0 END

        FROM (
            SELECT DISTINCT EOMONTH(DATEADD(MONTH,n,@FirstMonthStart)) AS AsOfDate
            FROM (
                SELECT ROW_NUMBER() OVER (ORDER BY (SELECT NULL)) - 1 AS n
                FROM sys.all_objects
            ) AS nums2
            WHERE DATEADD(MONTH,n,@FirstMonthStart) <= @LastMonthEnd
        ) AS me

        CROSS JOIN (
            SELECT
                tr.hPerson,
                SUM(
                    CASE WHEN tr.iType=7 AND SUBSTRING(ISNULL(tr.sNotes,''),1,4) <> ':HAP'
                         THEN ISNULL(tr.sTotalAmount,0) ELSE 0 END
                )
                -
                SUM(
                    CASE WHEN tr.iType=6 AND SUBSTRING(ISNULL(tr.sUserDefined2,''),1,4) <> ':HAP'
                         THEN ISNULL(tr.sTotalAmount,0) ELSE 0 END
                ) AS NetBefore
            FROM Trans tr
            WHERE CAST(tr.uPostDate AS date) < @FirstMonthStart
              AND tr.iType IN (6,7)
            GROUP BY tr.hPerson
        ) AS ci

        JOIN (
            SELECT t.hMyPerson, t.hUnit, t.hProperty
            FROM Tenant t
            JOIN TenStatus ts ON ts.iStatus = t.iStatus
            WHERE ts.Status LIKE 'Current%'
        ) AS tn ON tn.hMyPerson = ci.hPerson

    ) AS b

    GROUP BY
        b.AsOfDate,
        b.yardiPropertyRowID,
        b.yardiUnitRowID,
        b.yardiPersonRowID

) AS r

ORDER BY
    r.AsOfDate,
    r.yardiPropertyRowID,
    r.yardiUnitRowID,
    r.yardiPersonRowID;

//End Select

//COLUMNS
//Type, Name,               Head1,              Head2, Head3, Head4, Show, Color, Formula, Drill, Key,  Width, Total, Suppress
T,     AsOfDate,           AsOfDate,           ,      ,      ,      Y,    ,      ,        ,      ,    110,   N,     N,
N,     yardiPersonRowID,   yardiPersonRowID,   ,      ,      ,      Y,    ,      ,        ,      ,    90,    N,     N,
N,     yardiPropertyRowID, yardiPropertyRowID, ,      ,      ,      Y,    ,      ,        ,      ,    90,    N,     N,
N,     yardiUnitRowID,     yardiUnitRowID,     ,      ,      ,      Y,    ,      ,        ,      ,    90,    N,     N,
N,     balanceFwd,         balanceFwd,         ,      ,      ,      Y,    ,      ,        ,      ,    120,   N,     N,
N,     charges,            charges,            ,      ,      ,      Y,    ,      ,        ,      ,    120,   N,     N,
N,     receipts,           receipts,           ,      ,      ,      Y,    ,      ,        ,      ,    120,   N,     N,
N,     endingBalance,      endingBalance,      ,      ,      ,      Y,    ,      ,        ,      ,    120,   N,     N,
//End Columns

//FILTER
//Type, DataTyp,   Name,          Caption,     Key,   List,    Val1,   Val2, Mandatory, Multi-Type, Title, Title
//End Filter