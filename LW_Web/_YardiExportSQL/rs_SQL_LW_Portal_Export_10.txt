//Notes
//End Notes

//Title
LW Portal Export-File10
//End Title

//Select

DECLARE @RunMode varchar(20) = ISNULL(NULLIF('#RunMode#',''), 'Nightly'); 
DECLARE @NightlyDays int = 10;              
DECLARE @RetentionDays int = 90;       
DECLARE @ExcludeRecentDays int = 10;      

DECLARE @HAPMode varchar(10) = 'Include';  

DECLARE @AsOfEndOffsetDays int = 0;
DECLARE @AsOfEnd date = DATEADD(DAY, @AsOfEndOffsetDays, CAST(GETDATE() AS date));

DECLARE @ReconCutoff datetime = DATEADD(DAY, -30, GETDATE());

DECLARE @AsOfStart date;
DECLARE @AsOfEndEffective date;
DECLARE @WindowStart date;

IF @RunMode = 'Nightly'
BEGIN
    SET @AsOfEndEffective = @AsOfEnd;
    SET @AsOfStart = DATEADD(DAY, -(@NightlyDays - 1), @AsOfEndEffective);
END
ELSE
BEGIN
    SET @AsOfEndEffective = DATEADD(DAY, -@ExcludeRecentDays, @AsOfEnd);
    SET @WindowStart = DATEADD(DAY, -(@RetentionDays - 1), @AsOfEndEffective);
    SET @AsOfStart = @WindowStart;
END

DECLARE @FirstMonthStart date = DATEFROMPARTS(YEAR(@AsOfStart), MONTH(@AsOfStart), 1);

;WITH CurrentTenants AS
(
    SELECT
        t.hMyPerson,
        t.hUnit,
        t.hProperty,
        t.dtLastModified
    FROM Tenant t
    JOIN TenStatus ts ON ts.iStatus = t.iStatus
    JOIN property p   ON p.hMy = t.hProperty
    JOIN unit u       ON u.hMy = t.hUnit
    WHERE ts.Status LIKE 'Current%'
      AND ISNULL(p.bInactive,0) = 0  
      AND ISNULL(u.exclude,0)   = 0   
),
ChangedTenants AS
(
    SELECT ct.hMyPerson AS hPerson
    FROM CurrentTenants ct
    WHERE @RunMode = 'Nightly'

    UNION

    SELECT DISTINCT tr.hPerson
    FROM Trans tr
    JOIN CurrentTenants ct ON ct.hMyPerson = tr.hPerson
    WHERE @RunMode = 'MonthlyRecon'
      AND tr.iType IN (6,7)
      AND tr.hMy BETWEEN 600000000 AND 799999999
      AND (tr.SDATEMODIFIED >= @ReconCutoff OR tr.SDATECREATED >= @ReconCutoff)
      AND CAST(tr.UPOSTDATE AS date) BETWEEN @WindowStart AND @AsOfEndEffective

    UNION

    SELECT ct.hMyPerson
    FROM CurrentTenants ct
    WHERE @RunMode = 'MonthlyRecon'
      AND ct.dtLastModified >= @ReconCutoff
),
ChangedTenantsDistinct AS
(
    SELECT DISTINCT hPerson
    FROM ChangedTenants
),
DailyDates AS
(
    SELECT DATEADD(DAY, n, @AsOfStart) AS AsOfDate
    FROM
    (
        SELECT TOP (DATEDIFF(DAY, @AsOfStart, @AsOfEndEffective) + 1)
               ROW_NUMBER() OVER (ORDER BY (SELECT NULL)) - 1 AS n
        FROM sys.all_objects
    ) x
),
Tx AS
(
    SELECT
        tr.hPerson,
        tr.iType,
        CAST(tr.UPOSTDATE AS date) AS PostDate,
        tr.sTotalAmount,
        tr.sUserDefined2,
        tr.sNotes AS trNotes
    FROM Trans tr
    JOIN ChangedTenantsDistinct ct ON ct.hPerson = tr.hPerson
    WHERE tr.iType IN (6,7)
      AND tr.hMy BETWEEN 600000000 AND 799999999
      AND CAST(tr.UPOSTDATE AS date) BETWEEN @FirstMonthStart AND DATEADD(DAY, 1, @AsOfEndEffective)
),
CarryIn AS
(
    SELECT
        tr.hPerson,
        SUM(
            CASE WHEN tr.iType=7 AND SUBSTRING(ISNULL(tr.sNotes,''),1,4) <> ':HAP'
                 THEN ISNULL(tr.sTotalAmount,0) ELSE 0 END
        )
        -
        SUM(
            CASE WHEN tr.iType=6 AND SUBSTRING(ISNULL(tr.sUserDefined2,''),1,4) <> ':HAP'
                 THEN ISNULL(tr.sTotalAmount,0) ELSE 0 END
        ) AS NetBefore
    FROM Trans tr
    JOIN ChangedTenantsDistinct ct ON ct.hPerson = tr.hPerson
    WHERE CAST(tr.UPOSTDATE AS date) < @FirstMonthStart
      AND tr.iType IN (6,7)
      AND tr.hMy BETWEEN 600000000 AND 799999999
    GROUP BY tr.hPerson
),
B AS
(
    SELECT
        d.AsOfDate,
        tn.hProperty AS yardiPropertyRowID,
        tn.hUnit     AS yardiUnitRowID,
        tx.hPerson   AS yardiPersonRowID,
        tx.PostDate,
        tx.iType,

        CASE
            WHEN tx.iType=7 AND (
                (@HAPMode='Exclude' AND SUBSTRING(ISNULL(tx.trNotes,''),1,4)=':HAP')
                OR (@HAPMode='Only' AND SUBSTRING(ISNULL(tx.trNotes,''),1,4) <> ':HAP')
            ) THEN 0
            WHEN tx.iType=7 AND SUBSTRING(ISNULL(tx.trNotes,'N/A'),1,4) <> ':HAP'
            THEN ISNULL(tx.sTotalAmount,0)
            ELSE 0
        END AS ChargeAmt,

        CASE
            WHEN tx.iType=6 AND (
                (@HAPMode='Exclude' AND SUBSTRING(ISNULL(tx.sUserDefined2,''),1,4)=':HAP')
                OR (@HAPMode='Only' AND SUBSTRING(ISNULL(tx.sUserDefined2,''),1,4) <> ':HAP')
            ) THEN 0
            WHEN tx.iType=6 AND SUBSTRING(ISNULL(tx.sUserDefined2,'N/A'),1,4) <> ':HAP'
            THEN ISNULL(tx.sTotalAmount,0)
            ELSE 0
        END AS ReceiptAmt
    FROM DailyDates d
    JOIN Tx tx
      ON tx.PostDate <= d.AsOfDate
    JOIN CurrentTenants tn
      ON tn.hMyPerson = tx.hPerson

    UNION ALL

    SELECT
        d.AsOfDate,
        tn.hProperty,
        tn.hUnit,
        ci.hPerson,
        DATEADD(DAY, -1, @FirstMonthStart) AS PostDate,
        0 AS iType,
        CASE WHEN ci.NetBefore > 0 THEN ci.NetBefore ELSE 0 END AS ChargeAmt,
        CASE WHEN ci.NetBefore < 0 THEN -ci.NetBefore ELSE 0 END AS ReceiptAmt
    FROM DailyDates d
    JOIN CarryIn ci
      ON 1=1
    JOIN CurrentTenants tn
      ON tn.hMyPerson = ci.hPerson
),
R AS
(
    SELECT
        b.AsOfDate,
        b.yardiPropertyRowID,
        b.yardiUnitRowID,
        b.yardiPersonRowID,

        SUM(
            CASE WHEN b.PostDate < DATEFROMPARTS(YEAR(b.AsOfDate),MONTH(b.AsOfDate),1)
                 THEN (b.ChargeAmt - b.ReceiptAmt)
                 ELSE 0 END
        ) AS balanceFwd,

        SUM(
            CASE WHEN b.iType = 7
                  AND b.PostDate BETWEEN DATEFROMPARTS(YEAR(b.AsOfDate),MONTH(b.AsOfDate),1) AND b.AsOfDate
                 THEN b.ChargeAmt ELSE 0 END
        ) AS charges,

        SUM(
            CASE WHEN b.iType = 6
                  AND b.PostDate BETWEEN DATEFROMPARTS(YEAR(b.AsOfDate),MONTH(b.AsOfDate),1) AND b.AsOfDate
                 THEN b.ReceiptAmt ELSE 0 END
        ) AS receipts
    FROM B b
    GROUP BY
        b.AsOfDate,
        b.yardiPropertyRowID,
        b.yardiUnitRowID,
        b.yardiPersonRowID
)
SELECT
    r.AsOfDate,
    r.yardiPersonRowID,
    r.yardiPropertyRowID,
    r.yardiUnitRowID,
    CAST(r.balanceFwd AS decimal(12,2)) AS balanceFwd,
    CAST(r.charges    AS decimal(12,2)) AS charges,
    CAST(r.receipts   AS decimal(12,2)) AS receipts,
    CAST(r.balanceFwd + r.charges - r.receipts AS decimal(12,2)) AS endingBalance
FROM R r
ORDER BY
    r.AsOfDate,
    r.yardiPropertyRowID,
    r.yardiUnitRowID,
    r.yardiPersonRowID;

//End Select

//COLUMNS
//Type, Name,               Head1,              Head2, Head3, Head4, Show, Color, Formula, Drill, Key,  Width, Total, Suppress
T,     AsOfDate,           AsOfDate,           ,      ,      ,      Y,    ,      ,        ,      ,    110,   N,     N,
N,     yardiPersonRowID,   yardiPersonRowID,   ,      ,      ,      Y,    ,      ,        ,      ,    90,    N,     N,
N,     yardiPropertyRowID, yardiPropertyRowID, ,      ,      ,      Y,    ,      ,        ,      ,    90,    N,     N,
N,     yardiUnitRowID,     yardiUnitRowID,     ,      ,      ,      Y,    ,      ,        ,      ,    90,    N,     N,
N,     balanceFwd,         balanceFwd,         ,      ,      ,      Y,    ,      ,        ,      ,    120,   N,     N,
N,     charges,            charges,            ,      ,      ,      Y,    ,      ,        ,      ,    120,   N,     N,
N,     receipts,           receipts,           ,      ,      ,      Y,    ,      ,        ,      ,    120,   N,     N,
N,     endingBalance,      endingBalance,      ,      ,      ,      Y,    ,      ,        ,      ,    120,   N,     N,
//End Columns

//FILTER
//Type, DataTyp,   Name,          Caption,     Key,   List,    Val1,   Val2, Mandatory, Multi-Type, Title, Title
L,      T,      RunMode,    Run Mode,    ,   Nightly^MonthlyRecon,   ,   ,   Y,  ,  ,

//End Filter